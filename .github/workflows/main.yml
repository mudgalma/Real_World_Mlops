# name: CI/CD Pipeline

# on:
#   push:
#     branches: [main]

# jobs:
#   build-deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Setup Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: '3.10'

#       - name: Install dependencies
#         run: |
#           python -m pip install --upgrade pip

#           # Install pydantic first (needed by FastAPI)
#           pip install pydantic==1.10.15

#           # Install DVC first (so dependency conflict doesn’t break it)
#           pip install "dvc[gs]" --no-cache-dir

#           # 1️⃣ Install Evidently WITHOUT any dependencies
#           pip install evidently==0.7.3 --no-deps

#           # 2️⃣ Install Evidently dependencies manually (ALL except pydantic)
#           pip install ujson nltk deprecation typing-inspect uuid6 numpy pandas scipy requests PyYAML jinja2 matplotlib plotly

#           # 3️⃣ Install YOUR requirements file
#           # Ignore Evidently from requirements.txt to avoid reinstalling with deps
#           sed '/evidently/d' requirements.txt > req-clean.txt
#           pip install -r req-clean.txt --no-cache-dir

#       - name: Configure GCP auth
#         env:
#           GCP_B64: ${{ secrets.GCP_CREDENTIALS_B64 }}
#         run: |
#           echo "$GCP_B64" | base64 -d > gcp-key.json
#           gcloud auth activate-service-account --key-file=gcp-key.json
#           echo "GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/gcp-key.json" >> $GITHUB_ENV

#       - name: Authenticate Docker to Artifact Registry
#         run: |
#           gcloud auth configure-docker us-central1-docker.pkg.dev

#       - name: Build Docker image
#         run: docker build -t my-ml-app .

#       - name: Tag Docker image
#         run: docker tag my-ml-app us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/my-ml-app-repo/my-ml-app:latest

#       - name: Push Docker image
#         run: docker push us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/my-ml-app-repo/my-ml-app:latest

#       - name: Set up kubectl
#         uses: azure/setup-kubectl@v3

#       - name: Get GKE credentials
#         run: |
#           gcloud container clusters get-credentials my-ml-cluster --zone=us-central1-a

#       - name: Deploy to GKE
#         run: |
#           kubectl apply -f deployment.yaml
#           kubectl apply -f service.yaml
#           kubectl apply -f hpa.yaml
name: CI/CD Pipeline

on:
  push:
    branches: [main]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pydantic==1.10.15
          pip install "dvc[gs]" --no-cache-dir
          pip install evidently==0.7.3 --no-deps
          pip install ujson nltk deprecation typing-inspect uuid6 numpy pandas scipy requests PyYAML jinja2 matplotlib plotly
          sed '/evidently/d' requirements.txt > req-clean.txt
          pip install -r req-clean.txt --no-cache-dir

      # ✅ Working GCP auth (no apt install)
      - name: Set up GCP credentials and authenticate
        env:
          GCP_B64: ${{ secrets.GCP_CREDENTIALS_B64 }}
        run: |
          set -e
          echo "Decoding service account key..."
          echo "$GCP_B64" | base64 -d > gcp-key.json
          python3 -m json.tool gcp-key.json > /dev/null && echo "✓ Valid JSON key"

          echo "Authenticating with GCP..."
          gcloud auth activate-service-account --key-file=gcp-key.json
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
          echo "GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/gcp-key.json" >> $GITHUB_ENV

      - name: Authenticate Docker to Artifact Registry
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Build Docker image
        run: docker build -t my-ml-app .

      # ✅ Fix: ensure project ID exists (was empty → invalid reference format)
      - name: Tag Docker image
        run: |
          if [ -z "${{ secrets.GCP_PROJECT_ID }}" ]; then
            echo "❌ Missing GCP_PROJECT_ID secret!"
            exit 1
          fi
          docker tag my-ml-app us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/my-ml-app-repo/my-ml-app:latest

      - name: Push Docker image
        run: docker push us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/my-ml-app-repo/my-ml-app:latest

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_CREDENTIALS }}
          export_default_credentials: true
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Install GKE Auth Plugin
        run: |
          echo "Adding Google Cloud SDK repo..."
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
          sudo apt-get install -y apt-transport-https ca-certificates gnupg
          curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo tee /usr/share/keyrings/cloud.google.gpg > /dev/null
          sudo apt-get update -y
          sudo apt-get install -y google-cloud-sdk-gke-gcloud-auth-plugin


      - name: Configure GKE Auth Plugin
        run: echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV

      - name: Get GKE credentials
        run: gcloud container clusters get-credentials my-ml-cluster --zone=us-central1-a --project=${{ secrets.GCP_PROJECT_ID }}

      - name: Deploy to GKE
        run: |
          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml
          kubectl apply -f hpa.yaml




