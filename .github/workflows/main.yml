# name: CI/CD Pipeline

# on:
#   push:
#     branches: [main]

# jobs:
#   build-deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Setup Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: '3.10'

#       - name: Install dependencies
#         run: |
#           python -m pip install --upgrade pip

#           # Install pydantic first (needed by FastAPI)
#           pip install pydantic==1.10.15

#           # Install DVC first (so dependency conflict doesn‚Äôt break it)
#           pip install "dvc[gs]" --no-cache-dir

#           # 1Ô∏è‚É£ Install Evidently WITHOUT any dependencies
#           pip install evidently==0.7.3 --no-deps

#           # 2Ô∏è‚É£ Install Evidently dependencies manually (ALL except pydantic)
#           pip install ujson nltk deprecation typing-inspect uuid6 numpy pandas scipy requests PyYAML jinja2 matplotlib plotly

#           # 3Ô∏è‚É£ Install YOUR requirements file
#           # Ignore Evidently from requirements.txt to avoid reinstalling with deps
#           sed '/evidently/d' requirements.txt > req-clean.txt
#           pip install -r req-clean.txt --no-cache-dir

#       - name: Configure GCP auth
#         env:
#           GCP_B64: ${{ secrets.GCP_CREDENTIALS_B64 }}
#         run: |
#           echo "$GCP_B64" | base64 -d > gcp-key.json
#           gcloud auth activate-service-account --key-file=gcp-key.json
#           echo "GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/gcp-key.json" >> $GITHUB_ENV

#       - name: Authenticate Docker to Artifact Registry
#         run: |
#           gcloud auth configure-docker us-central1-docker.pkg.dev

#       - name: Build Docker image
#         run: docker build -t my-ml-app .

#       - name: Tag Docker image
#         run: docker tag my-ml-app us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/my-ml-app-repo/my-ml-app:latest

#       - name: Push Docker image
#         run: docker push us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/my-ml-app-repo/my-ml-app:latest

#       - name: Set up kubectl
#         uses: azure/setup-kubectl@v3

#       - name: Get GKE credentials
#         run: |
#           gcloud container clusters get-credentials my-ml-cluster --zone=us-central1-a

#       - name: Deploy to GKE
#         run: |
#           kubectl apply -f deployment.yaml
#           kubectl apply -f service.yaml
#           kubectl apply -f hpa.yaml

name: CI/CD Pipeline

on:
  push:
    branches: [main]

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # ------------------ 1Ô∏è‚É£ Checkout repo ------------------
      - name: Checkout
        uses: actions/checkout@v4

      # ------------------ 2Ô∏è‚É£ Setup Python ------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # ------------------ 3Ô∏è‚É£ Install dependencies ------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip

          # Install pydantic first (needed by FastAPI)
          pip install pydantic==1.10.15

          # Install DVC first (so dependency conflict doesn‚Äôt break it)
          pip install "dvc[gs]" --no-cache-dir

          # 1Ô∏è‚É£ Install Evidently WITHOUT any dependencies
          pip install evidently==0.7.3 --no-deps

          # 2Ô∏è‚É£ Install Evidently dependencies manually (ALL except pydantic)
          pip install ujson nltk deprecation typing-inspect uuid6 numpy pandas scipy requests PyYAML jinja2 matplotlib plotly

          # 3Ô∏è‚É£ Install YOUR requirements file (excluding evidently)
          sed '/evidently/d' requirements.txt > req-clean.txt
          pip install -r req-clean.txt --no-cache-dir

      # ------------------ 4Ô∏è‚É£ Authenticate to GCP ------------------
      - name: Set up GCP credentials and authenticate
        env:
          GCP_B64: ${{ secrets.GCP_CREDENTIALS_B64 }}
        run: |
          set -e
          echo "Decoding service account key..."
          echo "$GCP_B64" | base64 -d > gcp-key.json
          python3 -m json.tool gcp-key.json > /dev/null && echo "‚úì Valid JSON key"

          echo "Installing Google Cloud CLI..."
          sudo apt-get update -qq && sudo apt-get install -y google-cloud-cli

          echo "Authenticating with GCP..."
          gcloud auth activate-service-account --key-file=gcp-key.json
          gcloud config set project ${{ secrets.GCP_PROJECT_ID }}

          # Export for later steps
          echo "GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/gcp-key.json" >> $GITHUB_ENV

      # ------------------ 5Ô∏è‚É£ Authenticate Docker ------------------
      - name: Authenticate Docker to Artifact Registry
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev

      # ------------------ 6Ô∏è‚É£ Build Docker image ------------------
      - name: Build Docker image
        run: docker build -t my-ml-app .

      # ------------------ 7Ô∏è‚É£ Tag Docker image ------------------
      - name: Tag Docker image
        run: docker tag my-ml-app us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/my-ml-app-repo/my-ml-app:latest

      # ------------------ 8Ô∏è‚É£ Push Docker image ------------------
      - name: Push Docker image
        run: docker push us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/my-ml-app-repo/my-ml-app:latest

      # ------------------ 9Ô∏è‚É£ Setup kubectl ------------------
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3

      # ------------------ üîü Get GKE credentials ------------------
      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials my-ml-cluster --zone=us-central1-a

      # ------------------ 1Ô∏è‚É£1Ô∏è‚É£ Deploy to GKE ------------------
      - name: Deploy to GKE
        run: |
          kubectl apply -f deployment.yaml
          kubectl apply -f service.yaml
          kubectl apply -f hpa.yaml

